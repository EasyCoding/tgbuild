From 28ff839711926438018da162c4bb9591e1559015 Mon Sep 17 00:00:00 2001
From: John Preston <johnprestonmail@gmail.com>
Date: Sun, 26 Jul 2020 12:13:01 +0400
Subject: [PATCH] Fix linking with glibc wraps, libatomic.

---
 external/openssl/openssl_common/CMakeLists.txt |  1 +
 external/qt/CMakeLists.txt                     |  1 +
 options_linux.cmake                            | 14 +++++++-------
 3 files changed, 9 insertions(+), 7 deletions(-)

diff --git a/external/openssl/openssl_common/CMakeLists.txt b/external/openssl/openssl_common/CMakeLists.txt
index bae71ed..1e7656f 100644
--- a/cmake/external/openssl/openssl_common/CMakeLists.txt
+++ b/cmake/external/openssl/openssl_common/CMakeLists.txt
@@ -29,6 +29,7 @@ if (NOT DESKTOP_APP_USE_PACKAGED)
         if (DESKTOP_APP_USE_GLIBC_WRAPS)
             target_link_libraries(external_openssl_common
             INTERFACE
+                desktop-app::linux_glibc_wraps
                 $<TARGET_FILE:desktop-app::linux_glibc_wraps>
             )
         endif()
diff --git a/external/qt/CMakeLists.txt b/external/qt/CMakeLists.txt
index 885c358..aa5a3a8 100644
--- a/cmake/external/qt/CMakeLists.txt
+++ b/cmake/external/qt/CMakeLists.txt
@@ -357,6 +357,7 @@ else()
         if (DESKTOP_APP_USE_GLIBC_WRAPS)
             target_link_libraries(external_qt
             INTERFACE
+                desktop-app::linux_glibc_wraps
                 $<TARGET_FILE:desktop-app::linux_glibc_wraps>
             )
         endif()
diff --git a/options_linux.cmake b/options_linux.cmake
index e630ebf..a23ec02 100644
--- a/cmake/options_linux.cmake
+++ b/cmake/options_linux.cmake
@@ -48,14 +48,14 @@ if (NOT DESKTOP_APP_USE_PACKAGED)
 endif()
 
 if (DESKTOP_APP_USE_PACKAGED)
-    target_link_libraries(common_options
-    INTERFACE
-        atomic
-    )
+    find_library(ATOMIC_LIBRARY atomic)
 else()
-    target_link_static_libraries(common_options
+    find_library(ATOMIC_LIBRARY libatomic.a)
+endif()
+
+if (ATOMIC_LIBRARY)
+    target_link_libraries(common_options
     INTERFACE
-        atomic
+        ${ATOMIC_LIBRARY}
     )
 endif()
-
